{% extends 'core/base.html' %}
{% load static %}

{% block title %}Rate Limit Exceeded{% endblock %}

{% block content %}
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-lg border-danger">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <div style="font-size: 4rem; color: #dc3545; margin-bottom: 1rem;">
                            <i class="fas fa-exclamation-shield"></i>
                        </div>
                        <h1 class="text-danger">Too Many Attempts</h1>
                        <p class="text-muted mt-3">{{ message }}</p>
                    </div>
                    
                    <!-- Rate Limit Timer -->
                    <div class="alert alert-danger mb-4" role="alert">
                        <div class="d-flex align-items-center justify-content-center">
                            <i class="fas fa-hourglass me-3" style="font-size: 2rem;"></i>
                            <div>
                                <div class="small">Please wait before trying again</div>
                                <div style="font-size: 2rem; font-weight: bold;" id="retryTimer">15:00</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-shield-alt me-2"></i>
                        <strong>Why are you seeing this?</strong>
                        <p class="mb-0 mt-2">This is a security measure to protect your account from unauthorized access. Multiple failed attempts trigger this protection.</p>
                    </div>
                    
                    <div class="alert alert-warning" role="alert">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Tips:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Make sure you're entering the correct credentials</li>
                            <li>Check your email for OTP codes</li>
                            <li>If you're locked out, contact support</li>
                            <li>This restriction will automatically reset after the timer expires</li>
                        </ul>
                    </div>
                    
                    <div class="text-center mt-4">
                        <a href="/" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Go Back to Home
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Inline Timer Code -->
    <script>
        /**
         * Timer utility for OTP and rate limiting countdowns
         */
        class CountdownTimer {
            constructor(elementId, durationSeconds = 300, onComplete = null) {
                this.element = document.getElementById(elementId);
                this.duration = durationSeconds;
                this.remaining = durationSeconds;
                this.onComplete = onComplete;
                this.intervalId = null;
                this.startTime = null;
            }

            start() {
                if (!this.element) return;
                this.startTime = Date.now();
                this.remaining = this.duration;
                
                // Initial display
                this.updateDisplay();
                
                // Update every second
                this.intervalId = setInterval(() => {
                    this.remaining = Math.max(0, this.duration - Math.floor((Date.now() - this.startTime) / 1000));
                    this.updateDisplay();
                    
                    if (this.remaining <= 0) {
                        this.stop();
                        if (this.onComplete) this.onComplete();
                    }
                }, 100);
            }

            updateDisplay() {
                if (!this.element) return;
                const minutes = Math.floor(this.remaining / 60);
                const seconds = this.remaining % 60;
                this.element.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Color transitions
                if (this.remaining > this.duration * 0.5) {
                    this.element.style.color = '#28a745'; // Green
                } else if (this.remaining > this.duration * 0.2) {
                    this.element.style.color = '#ff6c00'; // Orange
                } else {
                    this.element.style.color = '#dc3545'; // Red
                }
            }

            stop() {
                if (this.intervalId) {
                    clearInterval(this.intervalId);
                    this.intervalId = null;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Calculate remaining time based on rate limit expiration
            let remainingSeconds = 900;  // Default: 15 minutes
            
            {% if expires_at %}
                const expiresAt = {{ expires_at }};  // Unix timestamp from server
                const currentTime = Date.now() / 1000;  // Convert to seconds
                const secondsRemaining = Math.floor(expiresAt - currentTime);
                remainingSeconds = Math.max(0, secondsRemaining);
            {% endif %}
            
            // Start rate limit timer with calculated remaining time
            const timer = new CountdownTimer('retryTimer', remainingSeconds, function() {
                // Redirect back when timer expires
                window.location.href = '{{ redirect_url|default:"/" }}';
            });
            timer.start();
        });
    </script>
{% endblock %}
